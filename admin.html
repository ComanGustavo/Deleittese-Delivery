<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Del√©ittese</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: white; font-family: sans-serif; }
        .pedido-card { background: #1e1e1e; border-left: 5px solid #ffc107; margin-bottom: 15px; }
        .pedido-listo { border-left-color: #28a745; opacity: 0.6; }
        .badge-pago { background: #444; color: #ffc107; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .items-lista { font-size: 0.9rem; color: #ccc; list-style: none; padding-left: 0; }
        .dato-contacto { color: #ff4d4d; font-weight: bold; }
        h1 { border-bottom: 2px solid #ffc107; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üì¶ Pedidos Entrantes</h1>
        <div class="d-flex gap-2">
            <span id="estado-impresion" class="badge bg-success">Auto-Impresi√≥n Activa</span>
            <button class="btn btn-outline-danger btn-sm" onclick="borrarHistorial()">Borrar Todo</button>
        </div>
    </div>

    <div id="contenedor-pedidos" class="row">
        <p class="text-center">Cargando conexi√≥n con Firebase...</p>
    </div>
</div>

<audio id="audio-notificacion" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB-EjyP-L-L-L-L-L-L-L-L-L-L", 
        authDomain: "deleittese-delivery.firebaseapp.com",
        databaseURL: "https://deleittese-delivery-default-rtdb.firebaseio.com",
        projectId: "deleittese-delivery",
        storageBucket: "deleittese-delivery.appspot.com",
        messagingSenderId: "324343076188",
        appId: "1:324343076188:web:8258cca8db166804b01d99"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();

    // --- LOGICA DE IMPRESI√ìN AUTOM√ÅTICA ---
    // Escucha cada vez que entra un pedido nuevo (child_added)
    database.ref('pedidos').on('child_added', (snapshot) => {
        const pedido = snapshot.val();
        const id = snapshot.key;

        // Si el pedido no ha sido impreso, disparamos la descarga
        if (pedido.estado === 'Pendiente' && !pedido.impreso) {
            descargarArchivoTicket(pedido, id);
            // Reproducir sonido de aviso
            document.getElementById('audio-notificacion').play().catch(e => console.log("Audio bloqueado"));
        }
    });

   function descargarArchivoTicket(p, id) {
    const ANCHO_TICKET = 30; // Est√°ndar para 58mm [cite: 2025-12-30]
    const linea = "=".repeat(ANCHO_TICKET);
    
    // Obtener fecha y hora actual [cite: 2026-01-08]
    const ahora = new Date();
    const fecha = ahora.toLocaleDateString();
    const hora = ahora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // N√∫mero de ticket (tomamos los √∫ltimos 4 caracteres del ID de Firebase)
    const nroTicket = id.substring(id.length - 4).toUpperCase();

    const centrar = (texto) => {
        const espacios = Math.max(0, Math.floor((ANCHO_TICKET - texto.length) / 2));
        return " ".repeat(espacios) + texto;
    };

    let itemsTxt = "";
    if (p.items) {
        itemsTxt = p.items.map(i => `${i.cant} x ${i.nombre}`).join('\n');
    }

    const contenido = `${centrar("DELEITTESE - DELIVERY")}
${centrar("Ticket: #" + nroTicket)}
${linea}
FECHA: ${fecha}
HORA:  ${hora}
${linea}
CLIENTE: ${p.cliente}
TEL: ${p.telefono}
DIR: ${p.direccion}
PAGO: ${p.pago}
${linea}
PRODUCTOS:
${itemsTxt}
${linea}
OBSERVACIONES:
${p.nota ? p.nota.toUpperCase() : 'SIN ACLARACIONES'}
${linea}
${centrar("TOTAL: " + p.total)}
${linea}
${centrar("¬°Gracias por elegirnos!")}`;

    // Proceso de descarga autom√°tica para Printfil
    const blob = new Blob([contenido], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `pedido_${id}.txt`;
    link.click();
    URL.revokeObjectURL(link.href);

    // Actualizar Firebase [cite: 2026-01-02]
    database.ref('pedidos/' + id).update({ impreso: true });
}

    // --- RENDERIZADO DEL PANEL ---
    database.ref('pedidos').on('value', (snapshot) => {
        const contenedor = document.getElementById('contenedor-pedidos');
        const pedidos = snapshot.val();
        contenedor.innerHTML = '';
        if (!pedidos) {
            contenedor.innerHTML = '<p class="text-center">No hay pedidos pendientes.</p>';
            return;
        }

        Object.keys(pedidos).reverse().forEach(id => {
            const p = pedidos[id];
            let itemsHtml = p.items ? p.items.map(i => `<li>‚Ä¢ ${i.cant} x ${i.nombre}</li>`).join('') : "";

            contenedor.innerHTML += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card pedido-card ${p.estado === 'Completado' ? 'pedido-listo' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <h5 class="card-title text-warning">${p.cliente}</h5>
                                <span class="badge-pago">${p.pago}</span>
                            </div>
                            <p class="mb-1 small">üìç <strong>Dir:</strong> <span class="dato-contacto">${p.direccion}</span></p>
                            <p class="mb-1 small">üìû <strong>Tel:</strong> <span class="dato-contacto">${p.telefono}</span></p>
                            <hr class="border-secondary">
                            <ul class="items-lista">${itemsHtml}</ul>
                            <div class="mb-2">
                                <small class="text-info">üìù <strong>Obs:</strong></small>
                                <div style="color: #00d4ff; font-weight: bold; font-size: 0.95rem;">${p.nota || 'Sin observaciones'}</div>
                            </div>
                            <h4 class="text-end text-success">${p.total}</h4>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-sm btn-success flex-grow-1" onclick="marcarCompletado('${id}')">Listo</button>
                                <button class="btn btn-sm btn-info text-white" onclick="reimprimir('${id}')">üìë Re-imprimir</button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarPedido('${id}')">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
    });

    function marcarCompletado(id) { database.ref('pedidos/' + id).update({ estado: 'Completado' }); }
    function eliminarPedido(id) { if(confirm("¬øEliminar?")) database.ref('pedidos/' + id).remove(); }
    function borrarHistorial() { if(confirm("¬øBorrar todo?")) database.ref('pedidos').remove(); }
    
    // Funci√≥n para volver a descargar el archivo si la impresora fall√≥
    function reimprimir(id) {
        database.ref('pedidos/' + id).once('value').then(s => {
            descargarArchivoTicket(s.val(), id);
        });
    }
</script>

</body>
</html>